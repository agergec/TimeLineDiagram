<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="version" content="2.0.0">
    <title>Timeline Diagram Editor</title>
    <link rel="icon"
        href="data:image/svg+xml,<svg xmlns='http://www.w3.org/2000/svg' viewBox='0 0 100 100'><circle cx='50' cy='50' r='48' fill='%232563eb'/><circle cx='50' cy='50' r='42' fill='%23fff'/><circle cx='50' cy='50' r='4' fill='%232563eb'/><line x1='50' y1='50' x2='50' y2='20' stroke='%232563eb' stroke-width='3' stroke-linecap='round'/><line x1='50' y1='50' x2='18' y2='51' stroke='%232563eb' stroke-width='4' stroke-linecap='round'/><circle cx='50' cy='14' r='3' fill='%232563eb'/><circle cx='86' cy='50' r='3' fill='%232563eb'/><circle cx='50' cy='86' r='3' fill='%232563eb'/><circle cx='14' cy='50' r='3' fill='%232563eb'/></svg>">
    <link rel="stylesheet" href="styles.css">
    <link
        href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;500;600;700&family=JetBrains+Mono:wght@400;500&display=swap"
        rel="stylesheet">
</head>

<body class="dark-theme">
    <script>
        (function () {
            try {
                if (localStorage.getItem('tld-theme') === 'light') {
                    document.body.classList.remove('dark-theme');
                    document.body.classList.add('light-theme');
                }
            } catch (_) {}
        })();
    </script>
    <div class="app-container">

        <!-- HEADER BAR (sip-parser-v2 style) -->
        <header class="header-bar">
            <div class="header-left">
                <div class="logo-icon">‚è±</div>
                <input type="text" id="diagram-title" class="title-input-v2" value="Timeline Diagram"
                    placeholder="Enter diagram title..." maxlength="150" title="Page title (max 150 characters)">
            </div>
            <div class="header-right">
                <span class="version-label">v2.0.0</span>
                <span class="header-badge" id="lock-badge" title="Diagram is locked">üîí</span>
            </div>
        </header>

        <!-- TOOLBAR -->
        <div class="toolbar">
            <div class="toolbar-left">
                <!-- File Group -->
                <button id="diagrams-toggle" class="toolbar-btn toolbar-has-badge" title="Manage diagrams" aria-label="Manage diagrams">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M3 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                    </svg>
                    <span class="sr-only">Diagrams</span>
                    <span id="diagrams-badge" class="badge empty">0</span>
                </button>
                <div class="toolbar-divider"></div>
                <button id="save-json" class="toolbar-btn icon-btn icon-only" title="Download diagram as JSON file" aria-label="Download diagram as JSON file">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 4v10"></path>
                        <path d="m8 10 4 4 4-4"></path>
                        <path d="M5 19h14"></path>
                    </svg>
                    <span class="sr-only">Download</span>
                </button>
                <button id="load-json" class="toolbar-btn icon-btn icon-only" title="Load diagram from JSON file" aria-label="Load diagram from JSON file">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M3 7a2 2 0 0 1 2-2h5l2 2h7a2 2 0 0 1 2 2v8a2 2 0 0 1-2 2H5a2 2 0 0 1-2-2z"></path>
                        <path d="M12 16v-6"></path>
                        <path d="m9 13 3-3 3 3"></path>
                    </svg>
                    <span class="sr-only">Load</span>
                </button>
                <div class="toolbar-divider"></div>
                <!-- Export Group -->
                <button id="share-url" class="toolbar-btn primary icon-btn icon-only"
                    title="Copy shareable URL to clipboard" aria-label="Copy shareable URL to clipboard">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M10 14a5 5 0 0 0 7.07 0l1.41-1.41a5 5 0 1 0-7.07-7.07L10 6"></path>
                        <path d="M14 10a5 5 0 0 0-7.07 0L5.52 11.4a5 5 0 0 0 7.07 7.08L14 17"></path>
                    </svg>
                    <span class="sr-only">Share</span>
                </button>
                <button id="export-png" class="toolbar-btn icon-btn icon-only" title="Export as PNG image" aria-label="Export as PNG image">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="3" y="5" width="18" height="14" rx="2"></rect>
                        <circle cx="8" cy="10" r="1.5"></circle>
                        <path d="m21 15-4-4-5 5-3-3-6 6"></path>
                    </svg>
                    <span class="sr-only">PNG</span>
                </button>
                <button id="export-svg" class="toolbar-btn icon-btn icon-only" title="Export as SVG vector" aria-label="Export as SVG vector">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="6" cy="7" r="2"></circle>
                        <circle cx="18" cy="7" r="2"></circle>
                        <circle cx="12" cy="17" r="2"></circle>
                        <path d="M8 8.3 10.7 15"></path>
                        <path d="M16 8.3 13.3 15"></path>
                        <path d="M8 7h8"></path>
                    </svg>
                    <span class="sr-only">SVG</span>
                </button>
                <div class="toolbar-divider"></div>
                <!-- Tools Group -->
                <a href="sip-parser.html" class="toolbar-btn icon-btn icon-only" title="Open SIP Parser" aria-label="Open SIP Parser">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M3 12h4l2-4 4 8 2-4h6"></path>
                    </svg>
                    <span class="sr-only">SIP Parser</span>
                </a>
            </div>
            <div class="toolbar-right">
                <!-- Zoom Controls -->
                <!-- Measurement Info (shown when measuring) -->
                <div id="measurement-bar" class="measurement-bar hidden">
                    <span class="measure-bar-label">Duration:</span>
                    <strong id="measure-bar-duration">‚Äî</strong>
                    <span class="measure-bar-sep">|</span>
                    <span class="measure-bar-label">S:</span>
                    <span id="measure-bar-start">‚Äî</span>
                    <span class="measure-bar-sep">|</span>
                    <span class="measure-bar-label">E:</span>
                    <span id="measure-bar-end">‚Äî</span>
                    <button id="measure-bar-pin" class="toolbar-btn icon-btn measure-bar-pin" title="Pin measurement" aria-label="Pin measurement">üìå</button>
                </div>
                <div class="zoom-controls-v2">
                    <button id="zoom-out" class="toolbar-btn icon-btn icon-only" title="Zoom Out" aria-label="Zoom Out">
                        <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <circle cx="11" cy="11" r="7"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                            <path d="M8 11h6"></path>
                        </svg>
                        <span class="sr-only">Zoom out</span>
                    </button>
                    <span id="zoom-level" class="zoom-label">100%</span>
                    <button id="zoom-in" class="toolbar-btn icon-btn icon-only" title="Zoom In" aria-label="Zoom In">
                        <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <circle cx="11" cy="11" r="7"></circle>
                            <path d="m21 21-4.35-4.35"></path>
                            <path d="M11 8v6"></path>
                            <path d="M8 11h6"></path>
                        </svg>
                        <span class="sr-only">Zoom in</span>
                    </button>
                    <button id="zoom-fit" class="toolbar-btn icon-btn icon-only" title="Fit to View" aria-label="Fit to View">
                        <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M4 9V4h5"></path>
                            <path d="M20 9V4h-5"></path>
                            <path d="M4 15v5h5"></path>
                            <path d="M20 15v5h-5"></path>
                        </svg>
                        <span class="sr-only">Fit</span>
                    </button>
                    <button id="compress-toggle" class="toolbar-btn icon-btn icon-only" title="Compress Empty Spaces" aria-label="Compress Empty Spaces">
                        <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                            <path d="M3 6v12"></path>
                            <path d="M21 6v12"></path>
                            <path d="m9 8-4 4 4 4"></path>
                            <path d="m15 8 4 4-4 4"></path>
                        </svg>
                        <span class="sr-only">Compress</span>
                    </button>
                </div>
                <button id="measure-tool-btn" class="toolbar-btn icon-btn icon-only"
                    title="Measurement Tool (‚åò+Click & Drag)" aria-label="Measurement Tool">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="3" y="7" width="18" height="10" rx="2"></rect>
                        <path d="M7 9v2"></path>
                        <path d="M10 9v3"></path>
                        <path d="M13 9v2"></path>
                        <path d="M16 9v3"></path>
                    </svg>
                    <span class="sr-only">Measure</span>
                </button>
                <div class="toolbar-divider"></div>
                <select id="config-time-threshold" class="toolbar-select"
                    title="Switch from ms to seconds/minutes when duration exceeds this threshold">
                    <option value="0">ms</option>
                    <option value="1000" selected>>1s</option>
                    <option value="5000">>5s</option>
                    <option value="60000">>1m</option>
                    <option value="-1">Custom - Threshold</option>
                </select>
                <label class="toolbar-toggle-btn icon-only" title="Display dashed lines at box start/end times">
                    <input type="checkbox" id="config-show-alignment" checked>
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M12 4v2"></path>
                        <path d="M12 9v2"></path>
                        <path d="M12 14v2"></path>
                        <path d="M12 19v1"></path>
                    </svg>
                    <span class="sr-only">Align</span>
                </label>
                <label class="toolbar-toggle-btn icon-only" title="Display persistent labels above narrow boxes">
                    <input type="checkbox" id="config-show-labels">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M6 7h12"></path>
                        <path d="M12 7v10"></path>
                        <path d="M8 17h8"></path>
                    </svg>
                    <span class="sr-only">Labels</span>
                </label>
                <label class="toolbar-toggle-btn icon-only" title="Hide left lane headers to gain space">
                    <input type="checkbox" id="config-compact-view">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="4" y="6" width="5" height="12" rx="1"></rect>
                        <rect x="11" y="6" width="9" height="12" rx="1"></rect>
                    </svg>
                    <span class="sr-only">Compact</span>
                </label>
                <label class="toolbar-toggle-btn icon-only" title="Automatically open properties panel when creating a new box">
                    <input type="checkbox" id="config-auto-open-properties">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="3.5" y="5" width="10.5" height="14" rx="2"></rect>
                        <path d="M6.5 9h4.5"></path>
                        <path d="M6.5 12h4.5"></path>
                        <path d="M6.5 15h4.5"></path>
                        <path d="M13 12h8"></path>
                        <path d="m17 8 4 4-4 4"></path>
                    </svg>
                    <span class="sr-only">Auto Open</span>
                </label>
                <label class="toolbar-toggle-btn icon-only" title="Prevent accidental edits">
                    <input type="checkbox" id="config-lock-diagram">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <rect x="5" y="10" width="14" height="10" rx="2"></rect>
                        <path d="M8 10V7a4 4 0 1 1 8 0v3"></path>
                    </svg>
                    <span class="sr-only">Lock</span>
                </label>
                <div class="toolbar-divider"></div>
                <button id="settings-btn" class="toolbar-btn icon-btn icon-only" title="Diagram Settings" aria-label="Diagram Settings">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M19.14 12.94c.04-.3.06-.61.06-.94 0-.32-.02-.64-.07-.94l2.03-1.58a.49.49 0 0 0 .12-.61l-1.92-3.32a.488.488 0 0 0-.59-.22l-2.39.96c-.5-.38-1.03-.7-1.62-.94l-.36-2.54a.484.484 0 0 0-.48-.41h-3.84c-.24 0-.43.17-.47.41l-.36 2.54c-.59.24-1.13.57-1.62.94l-2.39-.96a.488.488 0 0 0-.59.22L3.05 9.87a.49.49 0 0 0 .12.61l2.03 1.58c-.05.3-.09.63-.09.94s.02.64.07.94l-2.03 1.58a.49.49 0 0 0-.12.61l1.92 3.32c.12.22.39.3.61.22l2.39-.96c.5.38 1.03.7 1.62.94l.36 2.54c.04.24.24.41.48.41h3.84c.24 0 .44-.17.47-.41l.36-2.54c.59-.24 1.13-.56 1.62-.94l2.39.96c.22.08.49 0 .61-.22l1.92-3.32a.49.49 0 0 0-.12-.61l-2.03-1.58zM12 15.5c-1.93 0-3.5-1.57-3.5-3.5s1.57-3.5 3.5-3.5 3.5 1.57 3.5 3.5-1.57 3.5-3.5 3.5z" fill="currentColor" stroke="none"></path>
                    </svg>
                    <span class="sr-only">Settings</span>
                </button>
                <button id="theme-toggle-btn" class="toolbar-btn icon-btn icon-only" title="Toggle dark/light theme" aria-label="Toggle theme">
                    <svg class="toolbar-icon icon-moon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M20 15.5A8.5 8.5 0 1 1 11.5 4a7 7 0 1 0 8.5 11.5z"></path>
                    </svg>
                    <svg class="toolbar-icon icon-sun" viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="12" cy="12" r="4"></circle>
                        <path d="M12 2v2"></path>
                        <path d="M12 20v2"></path>
                        <path d="m4.9 4.9 1.4 1.4"></path>
                        <path d="m17.7 17.7 1.4 1.4"></path>
                        <path d="M2 12h2"></path>
                        <path d="M20 12h2"></path>
                        <path d="m4.9 19.1 1.4-1.4"></path>
                        <path d="m17.7 6.3 1.4-1.4"></path>
                    </svg>
                    <span class="sr-only">Theme</span>
                </button>
                <a href="JSON_FORMAT.html" target="_blank" rel="noopener" class="toolbar-btn icon-btn icon-only" title="Open JSON format documentation" aria-label="Open JSON format documentation">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <path d="M8 4c-2 0-2 2-2 2v2c0 1-1 2-2 2 1 0 2 1 2 2v2s0 2 2 2"></path>
                        <path d="M16 4c2 0 2 2 2 2v2c0 1 1 2 2 2-1 0-2 1-2 2v2s0 2-2 2"></path>
                    </svg>
                    <span class="sr-only">JSON Format</span>
                </a>
                <a href="help.html" class="toolbar-btn icon-btn icon-only" title="Help & Tutorial" aria-label="Help and tutorial">
                    <svg class="toolbar-icon" viewBox="0 0 24 24" aria-hidden="true">
                        <circle cx="12" cy="12" r="9"></circle>
                        <path d="M9.5 9a2.5 2.5 0 1 1 4.3 1.7c-.8.8-1.8 1.3-1.8 2.8"></path>
                        <circle cx="12" cy="17" r="0.8"></circle>
                    </svg>
                    <span class="sr-only">Help</span>
                </a>
            </div>
        </div>

        <!-- MAIN CONTENT -->
        <div class="main-content">
            <!-- Sidebar - Lane Management -->
            <aside class="sidebar">
                <div class="sidebar-header">
                    <h3>Lanes</h3>
                    <button id="add-lane" class="toolbar-btn primary" title="Add Lane">+ Add</button>
                </div>
                <div id="lane-list" class="lane-list">
                    <!-- Lanes will be dynamically added here -->
                </div>
                <div class="sidebar-footer">
                    <div class="made-by">Made by UCS with üíô</div>
                </div>
            </aside>

            <!-- Toast Container -->
            <div id="toast-container" class="toast-container"></div>

            <!-- Canvas Area -->
            <main class="canvas-container" id="canvas-container">
                <!-- Timeline Ruler -->
                <div class="timeline-ruler-container">
                    <div class="lane-label-spacer"></div>
                    <div id="timeline-ruler" class="timeline-ruler">
                        <!-- Ruler marks will be dynamically generated -->
                    </div>
                </div>

                <!-- Lanes Canvas -->
                <div id="lanes-canvas" class="lanes-canvas">
                    <!-- Alignment Markers Overlay (SVG) -->
                    <svg id="alignment-canvas-overlay" class="alignment-canvas-overlay"></svg>

                    <!-- Lane rows will be dynamically added here -->
                </div>

                <!-- Time Markers (vertical labels for box start/end times) -->
                <div class="time-markers-container">
                    <div class="lane-label-spacer"></div>
                    <div id="time-markers" class="time-markers">
                        <!-- Time markers will be dynamically generated -->
                    </div>
                </div>

                <!-- Timeline Footer with Minimap -->
                <div class="timeline-footer">
                    <div class="lane-label-spacer"></div>
                    <div class="minimap-container">
                        <canvas id="minimap-canvas"></canvas>
                        <div id="minimap-viewport" class="minimap-viewport"></div>
                    </div>
                    <div class="footer-info">
                        <span class="duration-label">Total:</span>
                        <span id="total-duration">0ms</span>
                    </div>
                </div>
            </main>

            <!-- Right Sidebar ‚Äî Properties/Settings Panel -->
            <aside id="right-sidebar" class="right-sidebar hidden">
                <div class="right-sidebar-header">
                    <h4 id="right-sidebar-title">Properties</h4>
                    <button id="close-right-sidebar" class="toolbar-btn icon-btn" title="Close">√ó</button>
                </div>
                <div class="right-sidebar-content">
                    <!-- Diagram Settings Mode -->
                    <div id="settings-props" class="props-section hidden">
                        <div class="form-group">
                            <label for="config-page-title">Page Title</label>
                            <input type="text" id="config-page-title" class="form-input" maxlength="150"
                                placeholder="Enter diagram title...">
                            <small class="text-muted">Displayed at the top of the page (max 150 chars)</small>
                        </div>
                        <div class="form-group">
                            <label for="config-start-time">Start Time</label>
                            <input type="text" id="start-time" class="form-input time-input-v2" value="00:00:00 000"
                                placeholder="HH:MM:SS sss">
                            <small class="text-muted">Absolute start time for the diagram</small>
                        </div>
                        <div class="form-group">
                            <label for="config-timeline-duration">Timeline Duration</label>
                            <div class="input-with-unit">
                                <input type="number" id="config-timeline-duration" class="form-input" value="8000"
                                    min="1000" max="600000" step="1000" style="width: 100px;">
                                <span class="unit">ms</span>
                            </div>
                            <small class="text-muted">Total canvas width in ms. Cannot be less than last box
                                end.</small>
                        </div>
                        <!-- Timeline Display Settings -->
                        <hr class="section-divider">
                        <div class="form-group">
                            <label for="config-trailing-space">Trailing Space</label>
                            <div class="input-with-unit">
                                <input type="range" id="config-trailing-slider" min="0" max="30000" value="1000"
                                    step="500">
                                <input type="number" id="config-trailing-space" class="form-input" value="1000" min="0"
                                    max="100000" style="width: 80px;">
                                <span class="unit">ms</span>
                            </div>
                            <small class="text-muted">Extra space after the last box</small>
                        </div>
                        <div class="form-group">
                            <label for="config-compression-threshold">Gap Compression Threshold</label>
                            <div class="input-with-unit">
                                <input type="range" id="config-compression-slider" min="50" max="2000" value="500"
                                    step="50">
                                <input type="number" id="config-compression-threshold" class="form-input" value="500"
                                    min="10" max="10000" style="width: 70px;">
                                <span class="unit">ms</span>
                            </div>
                            <small class="text-muted">Gaps larger than this are compressed (when enabled)</small>
                        </div>

                        <!-- Duration Scaling Section (PoC - Removable) -->
                        <hr class="section-divider">
                        <div class="form-group">
                            <label class="toggle-label">
                                <input type="checkbox" id="config-scaling-enabled">
                                <span>Enable Duration Scaling</span>
                            </label>
                            <small class="text-muted">Apply visual scaling to make small boxes more visible</small>
                        </div>
                        <div id="scaling-options" class="scaling-options hidden">
                            <div class="form-group">
                                <label for="config-scaling-mode">Scaling Mode</label>
                                <select id="config-scaling-mode" class="form-input">
                                    <option value="floor">A: Duration Floor</option>
                                    <option value="logarithmic">B: Logarithmic</option>
                                    <option value="compression">C: Compression</option>
                                    <option value="minWidth">D: Min Box Width</option>
                                </select>
                            </div>
                            <!-- Mode A: Floor -->
                            <div id="scaling-floor-opts" class="scaling-mode-opts">
                                <div class="form-group">
                                    <label for="config-floor-value">Minimum Visual Duration</label>
                                    <div class="input-with-unit">
                                        <input type="range" id="config-floor-slider" min="10" max="500" value="100"
                                            step="10">
                                        <input type="number" id="config-floor-value" class="form-input" value="100"
                                            min="1" max="1000" style="width: 80px;">
                                        <span class="unit">ms</span>
                                    </div>
                                    <small class="text-muted">All boxes will appear at least this wide</small>
                                </div>
                            </div>
                            <!-- Mode B: Logarithmic -->
                            <div id="scaling-log-opts" class="scaling-mode-opts hidden">
                                <div class="form-group">
                                    <label for="config-log-base">Log Base</label>
                                    <div class="input-with-unit">
                                        <input type="range" id="config-log-base-slider" min="2" max="20" value="10"
                                            step="1">
                                        <input type="number" id="config-log-base" class="form-input" value="10" min="2"
                                            max="100" style="width: 80px;">
                                    </div>
                                    <small class="text-muted">Higher = more compression of large values</small>
                                </div>
                                <div class="form-group">
                                    <label for="config-log-min">Base Duration</label>
                                    <div class="input-with-unit">
                                        <input type="number" id="config-log-min" class="form-input" value="10" min="1"
                                            max="100" style="width: 80px;">
                                        <span class="unit">ms</span>
                                    </div>
                                    <small class="text-muted">Reference point for scaling calculation</small>
                                </div>
                            </div>
                            <!-- Mode C: Compression -->
                            <div id="scaling-compression-opts" class="scaling-mode-opts hidden">
                                <div class="form-group">
                                    <label for="config-compression-factor">Compression Factor</label>
                                    <div class="input-with-unit">
                                        <input type="range" id="config-compression-factor-slider" min="0" max="1"
                                            value="0.5" step="0.1">
                                        <input type="number" id="config-compression-factor" class="form-input"
                                            value="0.5" min="0" max="1" step="0.1" style="width: 80px;">
                                    </div>
                                    <small class="text-muted">0 = all same size, 1 = no compression</small>
                                </div>
                            </div>
                            <!-- Mode D: Min Width -->
                            <div id="scaling-minwidth-opts" class="scaling-mode-opts hidden">
                                <div class="form-group">
                                    <label for="config-min-width">Minimum Box Width</label>
                                    <div class="input-with-unit">
                                        <input type="range" id="config-minwidth-slider" min="20" max="200" value="20"
                                            step="10">
                                        <input type="number" id="config-min-width" class="form-input" value="20"
                                            min="10" max="500" style="width: 80px;">
                                        <span class="unit">px</span>
                                    </div>
                                    <small class="text-muted">Override default 20px minimum box width</small>
                                </div>
                            </div>
                            <!-- Preview info -->
                            <div id="scaling-preview" class="scaling-preview">
                                <small class="text-muted">Scaling: <span id="scaling-mode-info">None</span></small>
                            </div>
                        </div>
                        <!-- End Duration Scaling Section -->

                        <hr class="section-divider">
                        <div class="form-group">
                            <label>Danger Zone</label>
                            <button id="purge-app-btn" class="toolbar-btn danger"
                                style="width: 100%; margin-top: 8px;">Purge Application</button>
                            <small class="text-muted">Completely removes all diagrams and settings from browser
                                storage.</small>
                        </div>
                    </div>

                    <!-- Lane Mode -->
                    <div id="lane-props" class="props-section hidden">
                        <div class="form-group">
                            <label for="lane-name">Lane Name</label>
                            <textarea id="lane-name" class="form-input" rows="3" style="resize: vertical;"></textarea>
                        </div>
                        <div class="form-group">
                            <label>Lane Color Theme</label>
                            <div id="lane-palette" class="palette-grid"></div>
                        </div>
                        <div class="form-actions">
                            <button id="delete-lane" class="toolbar-btn danger">Delete Lane</button>
                        </div>
                    </div>

                    <!-- Box Mode -->
                    <div id="box-props" class="props-section hidden">
                        <div class="form-group">
                            <label for="box-label">Label</label>
                            <input type="text" id="box-label" class="form-input" placeholder="Enter label...">
                        </div>
                        <div class="form-group">
                            <label for="box-color">Color</label>
                            <div class="color-picker-group">
                                <input type="color" id="box-color" class="color-picker" value="#4CAF50">
                                <div id="box-palette" class="palette-grid"></div>
                            </div>
                        </div>
                        <div class="form-row">
                            <div class="form-group">
                                <label for="box-start">Start (ms) <button id="pick-start-btn" class="icon-btn tiny"
                                        title="Set start from another box's end">üìç</button></label>
                                <input type="number" id="box-start" class="form-input" min="0" step="1">
                            </div>
                            <div class="form-group">
                                <label for="box-duration">Duration (ms)</label>
                                <input type="number" id="box-duration" class="form-input" min="1" step="1">
                            </div>
                        </div>
                        <div class="form-group">
                            <label for="box-end">End (ms)</label>
                            <input type="number" id="box-end" class="form-input" min="0" step="1" readonly>
                        </div>
                        <div class="form-group">
                            <label>Time Range (Absolute)</label>
                            <div class="time-range-display">
                                <span id="box-time-start">00:00:00 000</span>
                                <span>‚Üí</span>
                                <span id="box-time-end">00:00:00 000</span>
                            </div>
                        </div>
                        <div class="form-actions">
                            <button id="delete-box" class="toolbar-btn danger">Delete Box</button>
                        </div>
                    </div>
                </div>
            </aside>
        </div>

        <!-- Diagrams Modal -->
        <div id="diagrams-modal" class="modal-overlay hidden">
            <div class="modal-panel">
                <div class="modal-header">
                    <span>üìÅ My Diagrams</span>
                    <button id="close-diagrams-modal" class="modal-close">√ó</button>
                </div>
                <div id="diagrams-list" class="modal-body">
                    <!-- Diagrams will be dynamically added here -->
                </div>
                <div class="modal-footer">
                    <button id="purge-diagrams-btn" class="toolbar-btn danger" title="Purge unlocked diagrams">Purge</button>
                    <button id="new-diagram-btn" class="toolbar-btn primary">
                        <span id="new-diagram-btn-text">+ New Diagram</span>
                    </button>
                </div>
            </div>
        </div>

        <!-- Alignment Markers Container -->
        <svg id="alignment-markers" class="alignment-markers"></svg>

        <!-- Measurement Overlay -->
        <svg id="measurement-overlay" class="measurement-overlay">
            <defs>
                <!-- Start marker: simple | vertical line -->
                <marker id="measure-arrow-start" markerWidth="2" markerHeight="10" refX="1" refY="5" orient="auto">
                    <line x1="1" y1="0" x2="1" y2="10" stroke="#39FF14" stroke-width="1.5" />
                </marker>
                <!-- End marker: elegant > arrow with | line -->
                <marker id="measure-arrow-end" markerWidth="10" markerHeight="10" refX="10" refY="5" orient="auto">
                    <path d="M2,2 L8,5 L2,8" fill="none" stroke="#39FF14" stroke-width="1.5" stroke-linejoin="miter" />
                    <line x1="10" y1="0" x2="10" y2="10" stroke="#39FF14" stroke-width="1.5" />
                </marker>
            </defs>
            <line id="measurement-line" class="measurement-line" x1="0" y1="0" x2="0" y2="0"
                marker-start="url(#measure-arrow-start)" marker-end="url(#measure-arrow-end)" />
            <text id="measurement-label" class="measurement-label" x="0" y="0"></text>
        </svg>
        <div id="measurement-info" class="measurement-info"></div>

        <!-- Hidden File Input for Load -->
        <input type="file" id="file-input" accept=".json" style="display: none;">
    </div>

    <!-- Floating Properties Card (Timeline Precision Design) -->
    <div id="properties-card" class="properties-panel-floating hidden">
        <button class="properties-close" id="properties-close-btn">√ó</button>
        <div class="properties-header">
            <div class="properties-header-title">Properties</div>
        </div>

        <!-- Box Properties Section -->
        <div id="box-properties-section" class="hidden">
            <!-- Box Label -->
            <div class="property-section">
                <div class="property-section-title">Label</div>
                <div class="property-field">
                    <input type="text" id="props-box-label" placeholder="Box label" maxlength="50">
                </div>
            </div>

            <!-- Timing Section -->
            <div class="property-section">
                <div class="property-section-title">Timing</div>
                <div class="property-time-display">
                    <span class="property-time-label">Duration</span>
                    <span class="property-time-value" id="props-duration-display">‚Äî</span>
                </div>
                <div class="property-field" style="margin-top: var(--spacing-md);">
                    <label>Start Offset (ms)</label>
                    <input type="number" id="props-box-start" min="0" step="10">
                </div>
                <div class="property-field">
                    <label>Duration (ms)</label>
                    <input type="number" id="props-box-duration" min="10" step="10">
                </div>
                <div class="property-time-display" style="margin-top: var(--spacing-md); border-left-color: var(--accent-secondary);">
                    <span class="property-time-label">Absolute Time</span>
                    <span class="property-time-value" id="props-absolute-time">‚Äî</span>
                </div>
            </div>

            <!-- Color Section -->
            <div class="property-section">
                <div class="property-section-title">Appearance</div>
                <div class="property-field">
                    <label>Color</label>
                    <input type="color" id="props-box-color">
                </div>
            </div>
        </div>

        <!-- Lane Properties Section -->
        <div id="lane-properties-section" class="hidden">
            <div class="property-section">
                <div class="property-section-title">Lane Name</div>
                <div class="property-field">
                    <input type="text" id="props-lane-name" placeholder="Lane name" maxlength="50">
                </div>
            </div>
            <div class="property-section">
                <div class="property-section-title">Color</div>
                <div class="property-field">
                    <input type="color" id="props-lane-color">
                </div>
            </div>
        </div>
    </div>

    <!-- Dummies for app.js attributes to prevent init crash -->
    <!-- Include html2canvas for PNG export -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/html2canvas/1.4.1/html2canvas.min.js"></script>
    <script src="app.js"></script>
</body>

</html>
